# Performance Test

##性能衡量指标

一个系统的吞吐量（承压能力）与request对CPU的消耗、外部接口、IO等等紧密关联。

常规衡量指标：

* 并发数

* 响应时间

* 吞吐量

* 系统资源耗用

* 业务成功率

* TPS/QPS

Web指标相关：

- 注册用户数： 随时可能上线的用户数

- 在线用户数： 在线用户数是指某一时刻已经登录系统的用户数量

- 并发用户数: 指某一时刻向服务器发送请求的在线用户数 
    - 同一时刻向服务器发送相同或者不同请求的用户数，也就是说，既可以包括对某一业务的相同请求，也可以包括对多个业务的不同请求
    - 同一时刻向服务器发送相同请求的用户数，仅限于某一业务的相同请求

- 请求的响应时间
    - 响应时间就是用户感受软件系统为其服务所消耗的时间。
    - 对于web系统，请求的响应时间指的是从客户端发起的一个请求时间，到客户端接收到从服务器返回的响应结束。
        - 3s: Nice
        - 3-5s: Good
        - 5-10s: Acceptable 
        - \> 10s: Annoying

-  事务响应时间
    - 事务是指用户在客户端做一种或多种业务的操作集

- 每秒点击数
    - 每秒点击数是指每秒钟像web服务器提交的HTTP请求数，它是衡量服务器处理能力的一个常用指标。需要注意的是，这里的响应时间并非鼠标的一次单击操作，因为在一次单击操作中，客户端可能向服务器发出多个HTTP请求，切勿混淆。

- 吞吐率
    - 吞吐率通常指单位时间内从服务器返回的字节数，也可以单位时间内客户提交的请求数。吞吐率是大型web系统衡量自身负载能力的一个重要指标，一般来说，吞吐率越大，单位时间内处理的数据就越多，系统的负载能力也强。吞吐率yu很多因素有关，服务器的硬件配置，网络的宽带及拓扑结构，软件的技术架构等。

- 业务成功率
    - 指多用户对某一业务发起操作的成功率。例如，测试网络订票系统的并发处理性能，在早上8:00——8:30半小时的高峰里，要求能支持10万比订票业务，其中成功率不少于98%。也就是说系统允许200笔订票业务超时或者因其他原因导致未能订票成功。

- 资源利用率
    - 资源利用率就是指资源的使用情况，如CPU使用率、内存使用率、网络宽带的使用情况、磁盘I/O的输入输出量等系统硬件方面的监控指标。一个完整的系统是由软件和硬件组成，缺了任何一方都不可能成为一个正常运作的系统，所以资源利用率也是测试人员的一个监控点，并在当前软件的发展趋势下，硬件资源的成本也不可小视。

- 每秒事务数（TPS）
    - TPS表示服务器每秒处理的事务数，他是衡量系统处理能力的一个非常重要的指标，在性能测试中，通过检测不同用户的TPS,可以估算出系统处理能力的拐点。

- 访问量（PV）
    - 页面访问量（Page View）,每打开一次页面，PV计数+1，刷新页面也算。

- 访问数（UV）
    - 访问数（Unique Visitor）, 指独立访客的数量，一台电脑终端为一个访客。

- IP访问数（IV）
    - IV指的是独立IP访问数，计算是以一个独立的IP在一个计算时段内访问网站计算为1次IP访问数。在同一个计算时段内不管这个IP访问多少次均计算为1次。


## 分析方法总结
- 查看(redis)服务器链接情况和服务器health状况
- 查看压力服务器的各项指标
    - 磁盘性能 `sar`
    - 网络传输 `nmon`
        - 如hps达到100左右时，网络出口占用为120M/s, 这是千兆网卡的满载速率了
- 程序方面的思考
    - 线程池 考虑n内存溢出，异常或代码导致链接未释放多线程的问题
    - 并行转串行的逻辑模块会成为主要的瓶颈
    - 对数据库读写频繁的应用，可以考虑数据库长连接
    - 减少递归的使用，好的递归能提高效率，写的不好会消耗服务器资源
    - 字符串拼接时，避免使用+号而使用StringBuilder
    - 尽量减少正则表达式的使用
    - 对于连接，流等对象，有open就要有close，例如磁盘IO，网络IO，数据库连接等
    - 处理异常时，可以用选择 就不用try catch
    - 尽量把try catch放在循环的外层
    - 循环内尽量不要创建对象引用
    - 程序运行中避免使用反射，反射机制效率不高
    - 避免一次性载入过大的数据/文件到内存， 以免撑爆jvm, 建议使用缓存区读取的方式 
    - 嵌套循环使用前多做业务逻辑分析和确认
    - 前端尽量对非敏感数据，不经常变化的数据，页面资源，脚本文件等采用客户端缓存，减少服务器和客户端的互交数据量和互交过程
    - java写日志时候，控制频率和减少使用system.out, 使用框架提供的日志写入类
- 应用服务器参数排查注意点
    - 服务器崩溃： 每秒事务出现大幅度波动，且前台后台出现大量报错
    - 服务器对压力不敏感： 压力不停增加， 但服务器处理速度无显著变化，系统处理能力在较低水平但不崩溃
    - 服务器硬件指标数据较高，如CPU居高不下(如错误逻辑导致线程锁或大量system.out做写入)
    - 应用服务器内存使用持续走高(如大实例积压所致，常见于大量session/线程大量堆积（一个session一般占用10-20M左右的jvm内), 进而继续分析session/线程堆积d的问题
    - 应用服务器磁盘交换率居高不下 (意味着大量的文件写操作在进行)
    - 应用服务器网络流量居高不下(常见报文一般是2K-20K左右，可根据并发数计算大
致流量，若实际流量和计算明显不符，则需要排查到底是哪些连接在消耗流量，常见是一些图片、js等资源文件没有设置本地缓存)
    - 数据库服务器cpu居高不下 (一般常见于大量全表扫描，大量物理读，sql执行效率低下等情况，要配合top10 sql进一步查询)
    - 数据库服务器缓冲区命中率持续偏低 (偏低一般是小于95%, 常见于数据库配置有问题, 需联系DBA)
    - 数据库服务器网络流量居高不下 (结合业务和应用逻辑分析为什么会有大量数据在数据库和应用服务器z之间流动, 并根据实际情况看是否能简化逻辑，减少带宽消耗)
- 服务器配置排查
    - 未设置最大内存
    - 进程池/连接数 未设置最大连接数
    - java内存GC 
    - 日志配置： 建议按天输出
    - 日志级别： 建议日志级别调低，尽量只打印error级别日志
    - 系统核心参数： 一般常见于ulimit -a和sysctl.conf相关参数，用于控制系统级别的资源使用极限
    - 数据库连接池： 应用链接池很大，但数据库链接池只有5-10个甚至更小，当产生大量的耗时数据库查询时，请求的处理链就会阻塞在数据库查询上导致服务器资源耗尽，应用崩溃，而数据库层面没有异常
    
## 调优流程

<img src="/pic/tuning.png" width="70%">

## 公式相关
1、响应时间：对请求作出响应所需要的时间

    网络传输时间：N1+N2+N3+N4
    
    应用服务器处理时间：A1+A3
    
    数据库服务器处理时间：A2
    
    响应时间=N1+N2+N3+N4+A1+A3+A2

2、并发用户数的计算公式

    系统用户数：系统额定的用户数量，如一个OA系统，可能使用该系统的用户总数是5000个，那么这个数量，就是系统用户数。
    
    同时在线用户数：在一定的时间范围内，最大的同时在线用户数量。
    同时在线用户数=每秒请求数RPS（吞吐量）+并发连接数+平均用户思考时间
    
    平均并发用户数的计算：C=nL / T
    
    其中C是平均的并发用户数，n是平均每天访问用户数（login session），L是一天内用户从登录到退出的平均时间（login session的平均时间），T是考察时间长度（一天内多长时间有用户使用系统）
    
    并发用户数峰值计算：C^约等于C + 3*根号C
    
    其中C^是并发用户峰值，C是平均并发用户数，该公式遵循泊松分布理论。 

3、吞吐量的计算公式

    指单位时间内系统处理用户的请求数
    
    从业务角度看，吞吐量可以用：请求数/秒、页面数/秒、人数/天或处理业务数/小时等单位来衡量
    
    从网络角度看，吞吐量可以用：字节/秒来衡量
    
    对于交互式应用来说，吞吐量指标反映的是服务器承受的压力，他能够说明系统的负载能力
    
    以不同方式表达的吞吐量可以说明不同层次的问题，例如，以字节数/秒方式可以表示数要受网络基础设施、服务器架构、应用服务器制约等方面的瓶颈；已请求数/秒的方式表示主要是受应用服务器和应用代码的制约体现出的瓶颈。
    
    当没有遇到性能瓶颈的时候，吞吐量与虚拟用户数之间存在一定的联系，可以采用以下公式计算：F=VU * R /
    
    其中F为吞吐量，VU表示虚拟用户个数，R表示每个虚拟用户发出的请求数，T表示性能测试所用的时间

4、性能计数器

    是描述服务器或操作系统性能的一些数据指标，如使用内存数、进程时间，在性能测试中发挥着“监控和分析”的作用，尤其是在分析统统可扩展性、进行新能瓶颈定位时有着非常关键的作用。
    
    资源利用率：指系统各种资源的使用情况，如cpu占用率为68%，内存占用率为55%，一般使用“资源实际使用/总的资源可用量”形成资源利用率。

5、思考时间的计算公式

    Think Time，从业务角度来看，这个时间指用户进行操作时每个请求之间的时间间隔，而在做新能测试时，为了模拟这样的时间间隔，引入了思考时间这个概念，来更加真实的模拟用户的操作。
    
    在吞吐量这个公式中F=VU * R / T说明吞吐量F是VU数量、每个用户发出的请求数R和时间T的函数，而其中的R又可以用时间T和用户思考时间TS来计算：R = T / TS
    
    下面给出一个计算思考时间的一般步骤：
    
    1、首先计算出系统的并发用户数:    C=nL / T F=R×C
    
    2、统计出系统平均的吞吐量：      F=VU * R / T R×C = VU * R / T
    
    3、统计出平均每个用户发出的请求数量： R=u*C*T/VU
    
    4、根据公式计算出思考时间：  TS=T/R

##性能常规测试方法
- 性能测试类型包括负载测试，强度测试，容量测试等。
    - 负载测试（Load Testing）：核实在保持配置不变的情况下，测试对象在不同操作条件（如不同用户数、事务数等）下性能行为的可接受性, 最大支持多- 少并发用户数，软件请求出错率等，测试的主要是软件系统的性能。
    - 压力测试（Stress Testing）：强度测试也就是压力测试，压力测试主要是为了测试硬件系统是否达到需求文档设计的性能目标，譬如在- 一定时期内，系统的cpu利用率，内存使用率，磁盘I/O吞吐率，网络吞吐量等，压力测试和负载测试最大的差别在于测试目的不同。
    - 容量测试（Volume Testing）：确定系统最大承受量，譬如系统最大用户数，最大存储量，最多处理的数据流量等。
    - 基准测试： 比较新的或未知测试对象与已知参照标准（如现有软件或评测标准）的性能。
    - 争用测试： 核实测试对象对于多个主角对相同资源（数据记录、内存等）的请求的处理是否可以接受。
    - 性能配置： 核实在操作条件保持不变的情况下，测试对象在使用不同配置时其性能行为的可接受性。
    - 强度测试： 核实测试对象性能行为在异常或极端条件（如资源减少或用户数过多）之下的可接受性。
    - 渗入测试： 
        - 是一种比较简单的性能测试。渗入测试所需时间较长，它使用固定数目的并发用户测试系统的总体健壮性。
        - 这些测试将会通过内存泄漏、增加的垃圾收集（GC)或系统的其他问题，显示因长时间运行而出现的任何性能降低。测试运行的时间越久，您对系统就越了解。运行两次测试是一个好主意
        - 一次使用较低的用户负载（要在系统容量之下，以便不会出现执行队列），一次使用较高的负载（以便出现积极的执行队列）。
    - 峰谷测试： 兼有容量规划ramp-up类型测试和渗入测试的特征。
        - 其目标是确定从高负载（例如系统高峰时间的负载）恢复、转为几乎空闲、然后再攀升到高负载、再降低的能力。
实现这种测试的最好方法就是，进行一系列的快速ramp-up测试，继之以一段时间的平稳状态（取决于业务需求），然后急剧降低负载，此时可以令系统平息一下，然后再进行快速的ramp-up；反复重复这个过程。
        - 这样可以确定以下事项：第二次高峰是否重现第一次的峰值？其后的每次高峰是等于还是大于第一次的峰值？在测试过程中，系统是否显示了内存或GC性能降低的有关迹象？测试运行（不停地重复“峰值/空闲”周期）的时间越长，您对系统的长期健康状况就越了解。






